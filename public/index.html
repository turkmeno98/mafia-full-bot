<!DOCTYPE html>
<html>
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
    #phase { font-size: 24px; text-align: center; margin: 20px 0; }
    #players { display: flex; flex-wrap: wrap; gap: 10px; }
    .player { padding: 10px 15px; background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border-radius: 20px; font-weight: bold; }
    .dead { opacity: 0.5; }
    button { width: 100%; padding: 15px; margin: 10px 0; background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 10px; font-size: 18px; }
    #role { font-size: 20px; text-align: center; color: gold; }
    #chatHint { background: #f0f0f0; padding: 10px; border-radius: 10px; margin: 10px 0; text-align: center; }
  </style>
</head>
<body>
  <div id="phase">–õ–æ–±–±–∏: <span id="count">0</span>/12 –∏–≥—Ä–æ–∫–æ–≤</div>
  <div id="role"></div>
  <div id="players"></div>
  <div id="chatHint">üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —á–∞—Ç–µ –≥—Ä—É–ø–ø—ã</div>
  <button id="startBtn" onclick="startGame()">üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É (4+)</button>
  <button id="actionBtn" style="display:none;" onclick="sendAction()">‚ö° –î–µ–π—Å—Ç–≤–∏–µ (–Ω–æ—á—å)</button>
  <button onclick="Telegram.WebApp.close()">‚Üê –í —á–∞—Ç –≥—Ä—É–ø–ø—ã</button>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.MainButton.setText('–í —á–∞—Ç').show().onClick(() => Telegram.WebApp.close());
    
    const user = Telegram.WebApp.initDataUnsafe.user;
    const roomId = Telegram.WebApp.initDataUnsafe.chat?.id?.toString() || user.id.toString();
    const socket = io();  // –ê–≤—Ç–æ –∫ —Å–µ—Ä–≤–µ—Ä—É (—Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω)

    socket.emit('joinRoom', { roomId, userId: user.id, username: user.username || 'Anon' });

    socket.on('updatePlayers', (data) => {
      document.getElementById('count').textContent = data.count;
      document.getElementById('players').innerHTML = data.players.map(p => 
        `<span class="player">${p.username}</span>`
      ).join('');
    });

    socket.on('gameStart', (data) => {
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('actionBtn').style.display = 'block';
      document.getElementById('role').textContent = `–¢–≤–æ—è —Ä–æ–ª—å: ${data.role || '–ñ–∏—Ç–µ–ª—å'} ü§´`;
      document.getElementById('phase').textContent = 'üåô –ù–æ—á—å';
    });

    socket.on('nextPhase', (data) => {
      document.getElementById('phase').textContent = data.phase === 'night' ? 'üåô –ù–æ—á—å' : '‚òÄÔ∏è –î–µ–Ω—å';
    });

    function startGame() {
      socket.emit('startGame', roomId);
      Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
    function sendAction() {
      socket.emit('action', { roomId, action: 'mafia_kill' });  // –£—Ç–æ—á–Ω–∏ —Ä–æ–ª—å –ø–æ–∑–∂–µ
    }
  </script>
</body>
</html>
